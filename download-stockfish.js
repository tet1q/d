const https = require('https');
const http = require('http');
const fs = require('fs');
const path = require('path');
const tar = require('tar');

const STOCKFISH_URL = 'https://github.com/official-stockfish/Stockfish/releases/latest/download/stockfish-ubuntu-x86-64-avx2.tar';
const STOCKFISH_DIR = path.join(__dirname, 'stockfish');
const TAR_PATH = path.join(STOCKFISH_DIR, 'stockfish.tar');
const FINAL_PATH = path.join(STOCKFISH_DIR, 'stockfish-ubuntu');

console.log('ðŸ“¥ Downloading Stockfish...');
console.log(`ðŸ”— From: ${STOCKFISH_URL}`);

// Ensure stockfish directory exists
if (!fs.existsSync(STOCKFISH_DIR)) {
  fs.mkdirSync(STOCKFISH_DIR, { recursive: true });
    console.log('ðŸ“ Created stockfish directory');
    }

    function followRedirects(url, maxRedirects = 5) {
      return new Promise((resolve, reject) => {
          function follow(url, redirectsLeft) {
                if (redirectsLeft <= 0) {
                        reject(new Error('Too many redirects'));
                                return;
                                      }

                                            const protocol = url.startsWith('https') ? https : http;
                                                  
                                                        const request = protocol.get(url, (response) => {
                                                                if (response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {
                                                                          // Handle redirect
                                                                                    const newUrl = response.headers.location;
                                                                                              console.log(`ðŸ”€ Redirect to: ${newUrl}`);
                                                                                                        follow(newUrl, redirectsLeft - 1);
                                                                                                                } else if (response.statusCode === 200) {
                                                                                                                          resolve(response);
                                                                                                                                  } else {
                                                                                                                                            reject(new Error(`HTTP ${response.statusCode}`));
                                                                                                                                                    }
                                                                                                                                                          });

                                                                                                                                                                request.on('error', reject);
                                                                                                                                                                      request.setTimeout(30000, () => {
                                                                                                                                                                              request.destroy();
                                                                                                                                                                                      reject(new Error('Request timeout'));
                                                                                                                                                                                            });
                                                                                                                                                                                                }

                                                                                                                                                                                                    follow(url, maxRedirects);
                                                                                                                                                                                                      });
                                                                                                                                                                                                      }

                                                                                                                                                                                                      function downloadFile(url, dest) {
                                                                                                                                                                                                        return new Promise(async (resolve, reject) => {
                                                                                                                                                                                                            try {
                                                                                                                                                                                                                  const response = await followRedirects(url);
                                                                                                                                                                                                                        const file = fs.createWriteStream(dest);
                                                                                                                                                                                                                              
                                                                                                                                                                                                                                    response.pipe(file);
                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                let downloadedBytes = 0;
                                                                                                                                                                                                                                                      const totalBytes = parseInt(response.headers['content-length'] || '0');
                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                  response.on('data', (chunk) => {
                                                                                                                                                                                                                                                                          downloadedBytes += chunk.length;
                                                                                                                                                                                                                                                                                  if (totalBytes > 0) {
                                                                                                                                                                                                                                                                                            const percent = ((downloadedBytes / totalBytes) * 100).toFixed(1);
                                                                                                                                                                                                                                                                                                      process.stdout.write(`\rðŸ“¥ Downloading: ${percent}% (${(downloadedBytes / 1024 / 1024).toFixed(2)} MB)`);
                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                          file.on('finish', () => {
                                                                                                                                                                                                                                                                                                                                  file.close(() => {
                                                                                                                                                                                                                                                                                                                                            console.log('\nâœ… Download completed');
                                                                                                                                                                                                                                                                                                                                                      resolve();
                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                                                          file.on('error', (err) => {
                                                                                                                                                                                                                                                                                                                                                                                  fs.unlink(dest, () => reject(err));
                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                              response.on('error', (err) => {
                                                                                                                                                                                                                                                                                                                                                                                                      fs.unlink(dest, () => reject(err));
                                                                                                                                                                                                                                                                                                                                                                                                            });

                                                                                                                                                                                                                                                                                                                                                                                                                } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                      reject(error);
                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                            async function extractTar(filePath, extractDir) {
                                                                                                                                                                                                                                                                                                                                                                                                                              console.log('ðŸ“¦ Extracting Stockfish...');
                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                  try {
                                                                                                                                                                                                                                                                                                                                                                                                                                      await tar.x({
                                                                                                                                                                                                                                                                                                                                                                                                                                            file: filePath,
                                                                                                                                                                                                                                                                                                                                                                                                                                                  cwd: extractDir
                                                                                                                                                                                                                                                                                                                                                                                                                                                      });
                                                                                                                                                                                                                                                                                                                                                                                                                                                          console.log('âœ… Extraction completed');
                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Find the extracted file
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const files = fs.readdirSync(extractDir);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const stockfishFile = files.find(file => 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                file.startsWith('stockfish') && 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      !file.endsWith('.tar') &&
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            !file.includes('ubuntu') // bukan yang sudah kita rename
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (stockfishFile) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const oldPath = path.join(extractDir, stockfishFile);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fs.renameSync(oldPath, FINAL_PATH);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          console.log(`âœ… Renamed ${stockfishFile} to stockfish-ubuntu`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Jika tidak ditemukan, coba langsung pakai yang ada
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          console.log('âš ï¸  Could not find extracted stockfish file, checking existing files...');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.error('âŒ Extraction failed:', error.message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            throw error;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              async function setupStockfish() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Download the tar file with redirect handling
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await downloadFile(STOCKFISH_URL, TAR_PATH);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Extract tar file
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await extractTar(TAR_PATH, STOCKFISH_DIR);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Make executable
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (fs.existsSync(FINAL_PATH)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              fs.chmodSync(FINAL_PATH, 0o755);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.log('âœ… Made stockfish executable');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Coba cari file stockfish yang lain
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const files = fs.readdirSync(STOCKFISH_DIR);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const possibleFiles = files.filter(file => 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  file.startsWith('stockfish') && 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          !file.endsWith('.tar')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (possibleFiles.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const actualPath = path.join(STOCKFISH_DIR, possibleFiles[0]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            fs.renameSync(actualPath, FINAL_PATH);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fs.chmodSync(FINAL_PATH, 0o755);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.log(`âœ… Found and setup: ${possibleFiles[0]}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          throw new Error('No stockfish executable found after extraction');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Clean up tar file
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (fs.existsSync(TAR_PATH)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  fs.unlinkSync(TAR_PATH);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.log('âœ… Cleaned up temporary files');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Verify the file
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const stats = fs.statSync(FINAL_PATH);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.log(`âœ… Stockfish setup complete!`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.log(`ðŸ“Š File size: ${(stats.size / 1024 / 1024).toFixed(2)} MB`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.log(`ðŸ“ Location: ${FINAL_PATH}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Test if stockfish works
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.log('ðŸ§ª Testing Stockfish...');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const { spawn } = require('child_process');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const stockfish = spawn(FINAL_PATH);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            stockfish.stdin.write('uci\n');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stockfish.stdin.write('quit\n');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stockfish.stdout.on('data', (data) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (data.toString().includes('Stockfish')) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      console.log('âœ… Stockfish test: PASSED');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stockfish.on('close', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              console.log('ðŸŽ‰ Setup completed successfully!');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.error('âŒ Error setting up Stockfish:', error.message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.log('ðŸ’¡ Tips:');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.log('   - Check your internet connection');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.log('   - Try running: npm run download-stockfish again');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.log('   - Or download manually from:', STOCKFISH_URL);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            process.exit(1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Run setup
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              setupStockfish();